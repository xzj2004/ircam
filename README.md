# MLX90640 热成像相机项目

[English Version](README_EN.md)

## 项目简介

这是一个基于ESP32-C3和MLX90640红外热成像传感器的智能热成像相机项目。项目使用ESP-IDF框架开发，通过WiFi热点提供Web界面，实现实时热成像显示、温度测量和图像处理功能。

**项目作者：** 搞硬件的辛工  
**开源地址：** https://github.com/xzj2004/ircam  
**项目合作微信：** mcugogogo  
**开源协议：** MIT (允许自由修改发布及商用)

## 核心功能

### 1. 热成像数据采集
- **传感器：** MLX90640 32×24像素红外热成像传感器
- **分辨率：** 支持多种插值分辨率 (32×24, 96×72, 160×120, 224×168, 288×216, 384×288)
- **采样频率：** 可调节的数据采集频率
- **温度范围：** 支持自动和手动温度范围设置

### 2. 实时图像处理
- **插值算法：** 双线性插值和最近邻插值
- **色彩映射：** 支持彩虹图、热力图、地狱火、涡轮图等多种配色方案
- **图像增强：** 高斯模糊、温度范围平滑等高级处理功能
- **热点检测：** 自动识别并标记最高温度位置

### 3. Web界面控制
- **响应式设计：** 支持全屏显示和多种分辨率
- **实时控制：** 开始/停止采集、参数调节
- **高级设置：** 发射率调节、温度范围手动设置
- **FPS显示：** 实时帧率监控

### 4. 网络功能
- **WiFi热点：** 自动创建"IRCAM-XXXX"热点网络（XXXX为随机4位字母或数字）
- **Web服务器：** 内置HTTP服务器提供控制界面
- **多客户端支持：** 最多支持4个客户端同时连接

## 项目结构

```
platformio-code-Project/
├── src/                          # 主要源代码
│   ├── main.c                   # 主程序文件 (779行)
│   └── CMakeLists.txt          # CMake构建配置
├── lib/                         # 项目库文件
│   ├── MLX90640/               # MLX90640传感器驱动库
│   │   ├── MLX90640_API.h      # API接口头文件
│   │   ├── MLX90640_API.cpp    # API实现 (1184行)
│   │   └── MLX90640_I2C_Driver.h # I2C驱动接口
│   └── README                   # 库说明文档
├── data/                        # Web资源文件
│   └── web_script.js           # 前端JavaScript代码 (469行)
├── platformio.ini              # PlatformIO项目配置
├── partitions.csv              # ESP32分区表配置
└── extra_script.py             # 自定义构建脚本
```

## 核心代码位置说明

### 1. 主程序逻辑 - `src/main.c`

#### 热成像传感器初始化和配置
```c
// 第120-130行：I2C配置
#define I2C_MASTER_SCL_IO    GPIO_NUM_5        // I2C时钟引脚
#define I2C_MASTER_SDA_IO    GPIO_NUM_4        // I2C数据引脚
#define I2C_MASTER_FREQ_HZ   400000            // I2C频率400kHz

// 第132-135行：MLX90640配置
const uint8_t MLX90640_I2C_ADDR = 0x33;       // 传感器I2C地址
static paramsMLX90640 mlx90640_params;         // 传感器参数
static float mlx90640_temperatures[768];       // 温度数据缓冲区
```

#### I2C通信驱动实现
```c
// 第150-200行：MLX90640_I2CRead函数
// 实现从MLX90640读取数据的I2C通信

// 第200-250行：MLX90640_I2CWrite函数  
// 实现向MLX90640写入数据的I2C通信
```

#### 数据采集任务
```c
// 第300-400行：frameCaptureTask函数
// 负责持续采集热成像数据的FreeRTOS任务
```

#### Web服务器和HTTP处理
```c
// 第500-600行：HTTP请求处理函数
// 包括数据获取、参数设置等API接口
```

#### HTML页面生成
```c
// 第50-110行：HTML页面模板
// 包含完整的Web界面HTML代码
```

### 2. 前端JavaScript - `data/web_script.js`

#### 画布渲染和图像处理
```javascript
// 第1-50行：画布初始化和基本设置
const canvas = document.getElementById('thermalCanvas');
const ctx = canvas.getContext('2d');

// 第50-100行：色彩映射和插值算法
const colormaps = {
    hot: [[0,0,0],[0.3,0,0],[0.6,0.3,0],...],
    jet: [[0,0,0.5],[0,0,1],[0,1,1],...],
    // ... 其他配色方案
};
```

#### 实时数据获取和显示
```javascript
// 第200-300行：数据获取和渲染循环
// 实现与后端的数据通信和实时显示更新
```

#### 用户交互控制
```javascript
// 第300-400行：用户界面控制逻辑
// 包括分辨率切换、色彩方案选择、参数调节等
```

### 3. MLX90640驱动库 - `lib/MLX90640/`

#### API接口定义
```cpp
// MLX90640_API.h - 第1-73行
// 定义传感器操作的所有API函数接口
```

#### 核心算法实现
```cpp
// MLX90640_API.cpp - 第1-1184行
// 包含温度计算、校准、数据处理等核心算法
```

## 硬件连接

| ESP32-C3引脚 | MLX90640引脚 | 功能说明 |
|-------------|-------------|----------|
| GPIO5      | SCL         | I2C时钟线 |
| GPIO4      | SDA         | I2C数据线 |
| 3.3V       | VDD         | 电源正极 |
| GND        | VSS         | 电源地线 |

## 使用方法

### 1. 编译和烧录
```bash
# 使用PlatformIO编译
pio run

# 烧录到ESP32-C3
pio run --target upload
```

### 2. 连接和配置
1. 将MLX90640传感器连接到ESP32-C3的指定引脚
2. 上电后ESP32-C3会自动创建"IRCAM-XXXX" WiFi热点（XXXX为随机4位字母或数字）
3. 连接WiFi热点（无需密码）
4. 在浏览器中访问 ircam.com

### 3. 功能操作
- **开始采集：** 点击"开始采集"按钮启动热成像
- **分辨率调节：** 选择不同的插值分辨率
- **色彩方案：** 选择不同的温度色彩映射
- **高级设置：** 调节发射率、温度范围等参数

## 技术特点

- **实时性能：** 优化的数据采集和渲染算法
- **多分辨率支持：** 从原始32×24到384×288多种分辨率
- **高级图像处理：** 支持多种插值算法和图像增强
- **响应式Web界面：** 支持各种设备屏幕尺寸
- **开源协议：** MIT协议，支持商业使用

## 注意事项

- 本项目仅用于学习交流，请勿用于非法用途
- 使用前请确保MLX90640传感器正确连接
- 建议在通风良好的环境中使用，避免传感器过热
- 温度测量精度受环境因素影响，建议定期校准

## 贡献和合作

欢迎提交Issue和Pull Request来改进项目。如果您有创意想法或项目落地需求，欢迎通过微信 `mcugogogo` 联系作者进行合作。

## 许可证

本项目采用MIT开源协议，详情请参考LICENSE文件。 